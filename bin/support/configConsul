#!/bin/bash

set -e

product=$1
environment=$2

terraform output -json > output.json

address=$(jq ".postgres_db_address.value" output.json)

echo http://${product}-${environment}.urbanfortress.uk:8500/v1/agent/checks

until $(curl --output /dev/null --silent --fail http://${product}-${environment}.urbanfortress.uk:8500/v1/agent/checks); do
    printf '.'
    sleep 5
done

curl http://${product}-${environment}.urbanfortress.uk:8500/v1/catalog/register -X PUT --data-binary @- <<BODY
{
    "Datacenter": "dc1", 
    "Node": "rds", 
    "Address": ${address}, 
    "Service": {
            "Service": "postgres", 
            "Port": 5432
    }
}' 
BODY

printf "\n"